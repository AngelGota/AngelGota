name: Auto-assign + Auto-approve (como AngelGota)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  contents: read
  pull-requests: write
  checks: read
  statuses: read

jobs:
  assign-and-approve:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign y solicitar review
        uses: actions-ecosystem/action-add-assignees@v1
        with:
          assignees: AngelGota
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Solicitar reviewers
        uses: actions-ecosystem/action-request-reviewers@v1
        with:
          reviewers: AngelGota
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Esperar a que pasen los checks
        uses: lewagon/wait-on-check-action@v1.3.3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          wait-interval: 10
          allowed-conclusions: success,neutral,skipped
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Aprobar PR como AngelGota
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          gh pr review "$PR" --repo "$REPO" --approve --body "Auto-approval by AngelGota (CI checks OK)."

      - name: Etiquetar automerge
        if: success()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: automerge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
