name: Fill (except GOTA pixels) ‚Äì every 5 min, unlimited commits

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fill-not-gota-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fill-not-gota:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run (skip GOTA pixels; commit otherwise)
        shell: bash
        run: |
          set -euo pipefail

          # ---------- CONFIG ----------
          START_G="2025-02-09"   # domingo inicio G
          START_O="2025-06-08"   # domingo inicio O
          START_T="2025-10-05"   # domingo inicio T
          START_A="2026-02-08"   # domingo inicio A

          # D√≠as prohibidos expl√≠citos (UTC), separados por espacio:
          AVOID_DATES=""

          COMMIT_PREFIX="chore: auto-fill (not GOTA)"
          today_utc="$(date -u +%F)"
          # ---------- FIN CONFIG ----------

          # Aux: sumar d√≠as
          add_days() { date -u -d "$1 + $2 days" +%F; }

          # Genera fechas (YYYY-MM-DD) para cada '#' de una matriz 7x5
          emit_dates() {
            local sunday="$1"; shift
            local name="$1"; shift
            local r c ch line d
            for r in {0..6}; do
              line="${1}"; shift
              for c in {0..4}; do
                ch="${line:$c:1}"
                if [[ "$ch" == "#" ]]; then
                  d=$(add_days "$sunday" $(( c*7 + r )))
                  echo "$d $name"
                fi
              done
            done
          }

          # Letras (fila 0=Dom, 6=S√°b)
          mapfile -t GDATES < <(emit_dates "$START_G" "G" \
            " ### " \
            "#   #" \
            "#    " \
            "#  ##" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t ODATES < <(emit_dates "$START_O" "O" \
            " ### " \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t TDATES < <(emit_dates "$START_T" "T" \
            "#####" \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " )

          mapfile -t ADATES < <(emit_dates "$START_A" "A" \
            " ### " \
            "#   #" \
            "#   #" \
            "#####" \
            "#   #" \
            "#   #" \
            "#   #" )

          ALL=("${GDATES[@]}" "${ODATES[@]}" "${TDATES[@]}" "${ADATES[@]}")

          # 1) Saltar si hoy est√° prohibido expl√≠citamente
          for bad in $AVOID_DATES; do
            if [[ "$today_utc" == "$bad" ]]; then
              echo "Hoy ($today_utc) est√° en AVOID_DATES. No commit."
              exit 0
            fi
          done

          # 2) Detectar si HOY es p√≠xel de G/O/T/A (si lo es, NO commitear)
          for rec in "${ALL[@]}"; do
            d="${rec%% *}"
            if [[ "$d" == "$today_utc" ]]; then
              echo "Hoy $today_utc es p√≠xel de GOTA. Pol√≠tica invertida: NO commit."
              exit 0
            fi
          done

          echo "Hoy $today_utc es contorno toca pintar. Se hace commit."

          # 3) Commit (sin l√≠mite diario)
          mkdir -p automation/data
          DATE_FULL="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # contador global s√≥lo informativo
          GLOBAL_COUNT=$(git log --grep="$COMMIT_PREFIX" --oneline | wc -l | tr -d ' ')
          GLOBAL_NEXT=$((GLOBAL_COUNT + 1))

          # escribimos un estado para asegurar cambio
          {
            echo "‚úÖ Fill (not GOTA pixel)"
            echo "üóìÔ∏è  Fecha (UTC): $today_utc"
            echo "‚è±Ô∏è  Run: $DATE_FULL"
            echo "üî¢ Global (aprox): #$GLOBAL_NEXT"
          } > automation/data/fill_status.md

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add automation/data/fill_status.md
          git commit -m "$COMMIT_PREFIX #$GLOBAL_NEXT ($today_utc) $(date -u +%H:%M:%S)" || exit 0
          git push
