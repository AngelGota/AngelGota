name: Draw GOTA (5min, up to 20 commits/day)

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos (UTC)
  workflow_dispatch:

permissions:
  contents: write

# Evita solapes si un job anterior a√∫n corre cuando llega el siguiente
concurrency:
  group: gota-${{ github.ref }}
  cancel-in-progress: true

jobs:
  draw-gota:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Dibujar si toca (con tope 20 commits en el d√≠a UTC)
        shell: bash
        run: |
          set -euo pipefail

          # ---------- CONFIG ----------
          # Domingos de inicio (columna 0 de cada letra)
          START_G="2025-02-09"
          START_O="2025-06-08"
          START_T="2025-10-05"
          START_A="2026-02-08"

          # D√≠as que NO deben tener commits (UTC) ‚Äî a√±ade los que quieras
          # ejemplo: AVOID_DATES="2025-10-26 2025-12-31 2026-01-01"
          AVOID_DATES=""

          # Prefijo para buscar/contar commits del bot
          COMMIT_PREFIX="chore: auto-update heartbeat"

          # L√≠mite de commits por d√≠a (UTC)
          DAILY_LIMIT=20
          # ---------- FIN CONFIG ----------

          today_utc="$(date -u +%F)"

          # Aux: sumar d√≠as
          add_days() { date -u -d "$1 + $2 days" +%F; }

          # Genera fechas (YYYY-MM-DD) donde hay "#"
          emit_dates() {
            local sunday="$1"; shift
            local name="$1"; shift
            local r c ch line d
            for r in {0..6}; do
              line="${1}"; shift
              for c in {0..4}; do
                ch="${line:$c:1}"
                if [[ "$ch" == "#" ]]; then
                  d=$(add_days "$sunday" $(( c*7 + r )))
                  echo "$d $name"
                fi
              done
            done
          }

          # Definici√≥n 7x5 por letra (fila 0=Dom, 6=S√°b)
          mapfile -t GDATES < <(emit_dates "$START_G" "G" \
            " ### " \
            "#   #" \
            "#    " \
            "#  ##" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t ODATES < <(emit_dates "$START_O" "O" \
            " ### " \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t TDATES < <(emit_dates "$START_T" "T" \
            "#####" \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " )

          mapfile -t ADATES < <(emit_dates "$START_A" "A" \
            " ### " \
            "#   #" \
            "#   #" \
            "#####" \
            "#   #" \
            "#   #" \
            "#   #" )

          ALL=("${GDATES[@]}" "${ODATES[@]}" "${TDATES[@]}" "${ADATES[@]}")

          # 1) Saltar si hoy est√° expl√≠citamente prohibido
          for bad in $AVOID_DATES; do
            if [[ "$today_utc" == "$bad" ]]; then
              echo "Hoy ($today_utc) est√° en AVOID_DATES. No se dibuja."
              exit 0
            fi
          done

          # 2) ¬øHoy es un p√≠xel del dibujo?
          hit=""
          for rec in "${ALL[@]}"; do
            d="${rec%% *}"
            letter="${rec##* }"
            if [[ "$d" == "$today_utc" ]]; then
              hit="$letter"
              break
            fi
          done

          if [[ -z "$hit" ]]; then
            echo "Hoy $today_utc no es d√≠a de p√≠xel. Nada que hacer."
            exit 0
          fi
          echo "Hoy $today_utc es un p√≠xel de la letra: $hit"

          # 3) Respetar tope de 20 commits en el d√≠a (UTC)
          # Contamos commits del bot HOY buscando la fecha en el mensaje
          TODAY_COUNT=$(git log --grep="$COMMIT_PREFIX" --grep="($today_utc)" --oneline | wc -l | tr -d ' ')
          if [[ "$TODAY_COUNT" -ge "$DAILY_LIMIT" ]]; then
            echo "L√≠mite diario alcanzado ($TODAY_COUNT >= $DAILY_LIMIT). No commiteo."
            exit 0
          fi
          TODAY_NEXT=$((TODAY_COUNT + 1))

          # 4) Correlativo global (#N) para el mensaje
          GLOBAL_COUNT=$(git log --grep="$COMMIT_PREFIX" --oneline | wc -l | tr -d ' ')
          GLOBAL_NEXT=$((GLOBAL_COUNT + 1))

          # 5) Escribir/commitear
          mkdir -p automation/data
          DATE_FULL="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          {
            echo "üß© GOTA pixel: $hit"
            echo "üóìÔ∏è  Fecha (UTC): $today_utc"
            echo "‚è±Ô∏è  Run: $DATE_FULL"
            echo "üî¢ Hoy: $TODAY_NEXT / $DAILY_LIMIT"
            echo "üî¢ Global: #$GLOBAL_NEXT"
          } > automation/data/gota_pixel.md

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add automation/data/gota_pixel.md
          if git diff --cached --quiet; then
            echo "No hay cambios"
            exit 0
          fi

          git commit -m "$COMMIT_PREFIX #$GLOBAL_NEXT [GOTA:$hit] ($today_utc) (run $TODAY_NEXT/$DAILY_LIMIT)"
          git push
