name: Fill (except GOTA pixels) – every 5 min, unlimited commits

on:
  schedule:
    - cron: "*/10 * * * *"   # cada 5 min (UTC)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: fill-not-gota-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fill-not-gota:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run (skip GOTA pixels; commit otherwise)
        shell: bash
        run: |
          set -euo pipefail

          # ---------- CONFIG ----------
          START_G="2025-02-09"
          START_O="2025-06-08"
          START_T="2025-10-05"
          START_A="2026-02-08"

          # Fechas que NUNCA deben tener commits
          AVOID_DATES="2025-12-31 2026-01-01"

          COMMIT_PREFIX="chore: auto-fill (not GOTA)"
          # ---------- FIN CONFIG ----------

          today_utc="$(date -u +%F)"

          add_days() { date -u -d "$1 + $2 days" +%F; }

          emit_dates() {
            local sunday="$1"; shift
            local name="$1"; shift
            local r c ch line d
            for r in {0..6}; do
              line="${1}"; shift
              for c in {0..4}; do
                ch="${line:$c:1}"
                if [[ "$ch" == "#" ]]; then
                  d=$(add_days "$sunday" $(( c*7 + r )))
                  echo "$d $name"
                fi
              done
            done
          }

          mapfile -t GDATES < <(emit_dates "$START_G" "G" \
            " ### " \
            "#   #" \
            "#    " \
            "#  ##" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t ODATES < <(emit_dates "$START_O" "O" \
            " ### " \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            "#   #" \
            " ### " )

          mapfile -t TDATES < <(emit_dates "$START_T" "T" \
            "#####" \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " \
            "  #  " )

          mapfile -t ADATES < <(emit_dates "$START_A" "A" \
            " ### " \
            "#   #" \
            "#   #" \
            "#####" \
            "#   #" \
            "#   #" \
            "#   #" )

          ALL=("${GDATES[@]}" "${ODATES[@]}" "${TDATES[@]}" "${ADATES[@]}")

          # 1️⃣ Saltar si está en lista de fechas prohibidas
          for bad in $AVOID_DATES; do
            if [[ "$today_utc" == "$bad" ]]; then
              echo "Hoy ($today_utc) está en AVOID_DATES. No se hace commit."
              exit 0
            fi
          done

          # 2️⃣ Si es día-píxel de G/O/T/A → no commit
          for rec in "${ALL[@]}"; do
            d="${rec%% *}"
            if [[ "$d" == "$today_utc" ]]; then
              echo "Hoy $today_utc es píxel de GOTA → no commit."
              exit 0
            fi
          done

          echo "✅ Hoy $today_utc NO es píxel de GOTA. Se hará commit."

          # 3️⃣ Generar commit
          mkdir -p automation/data
          DATE_FULL="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          {
            echo "Día normal (relleno)"
            echo "Fecha UTC: $DATE_FULL"
