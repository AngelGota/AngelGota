name: Auto Fill ‚Üí feature/auto-fill ‚Üí PR a main

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos (UTC)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-fill-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Config Git (autor = t√∫)
        run: |
          git config user.name  "AngelGota"
          git config user.email "gangelos630@gmail.com"

      - name: Preparar rama feature/auto-fill
        run: |
          git fetch origin main
          git checkout -B feature/auto-fill origin/main

      - name: Ejecutar l√≥gica (no pintar GOTA; commit inverso)
        shell: bash
        run: |
          set -euo pipefail

          # ---------- CONFIG ----------
          START_G="2025-02-09"
          START_O="2025-06-08"
          START_T="2025-10-05"
          START_A="2026-02-08"
          AVOID_DATES=""
          COMMIT_PREFIX="chore: auto-fill (not GOTA)"
          today_utc="$(date -u +%F)"
          # ---------- FIN CONFIG ----------

          # Funciones auxiliares
          add_days() { date -u -d "$1 + $2 days" +%F; }
          emit_dates() {
            local sunday="$1"; shift
            local r c ch line d
            for r in {0..6}; do
              line="${1}"; shift
              for c in {0..4}; do
                ch="${line:$c:1}"
                if [[ "$ch" == "#" ]]; then
                  d=$(add_days "$sunday" $(( c*7 + r )))
                  echo "$d"
                fi
              done
            done
          }

          # Definici√≥n de letras
          mapfile -t G < <(emit_dates "$START_G" " ### " "#   #" "#    " "#  ##" "#   #" "#   #" " ### ")
          mapfile -t O < <(emit_dates "$START_O" " ### " "#   #" "#   #" "#   #" "#   #" "#   #" " ### ")
          mapfile -t T < <(emit_dates "$START_T" "#####" "  #  " "  #  " "  #  " "  #  " "  #  " "  #  ")
          mapfile -t A < <(emit_dates "$START_A" " ### " "#   #" "#   #" "#####" "#   #" "#   #" "#   #")

          # Saltar si es d√≠a prohibido o p√≠xel de GOTA
          for d in $AVOID_DATES; do [[ "$d" == "$today_utc" ]] && echo "D√≠a evitado." && exit 0; done
          for d in "${G[@]}" "${O[@]}" "${T[@]}" "${A[@]}"; do [[ "$d" == "$today_utc" ]] && echo "P√≠xel de GOTA ‚Üí sin commit" && exit 0; done

          echo "Hoy $today_utc es contorno. Se hace commit."

          # Commit autom√°tico
          mkdir -p automation/data
          DATE_FULL="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          GLOBAL_COUNT=$(git log --grep="$COMMIT_PREFIX" --oneline | wc -l | tr -d ' ')
          GLOBAL_NEXT=$((GLOBAL_COUNT + 1))

          {
            echo "‚úÖ Fill (not GOTA pixel)"
            echo "üóìÔ∏è  Fecha (UTC): $today_utc"
            echo "‚è±Ô∏è  Run: $DATE_FULL"
            echo "üî¢ Global: #$GLOBAL_NEXT"
          } > automation/data/fill_status.md

          git add automation/data/fill_status.md
          git commit --author="AngelGota <gangelos630@gmail.com>" -m "$COMMIT_PREFIX #$GLOBAL_NEXT ($today_utc) $(date -u +%H:%M:%S)" || exit 0
          git push -u origin feature/auto-fill

      - name: Crear o actualizar PR hacia main
        uses: peter-evans/create-pull-request@v6
        with:
          branch: feature/auto-fill
          base: main
          title: "feat: auto-fill ‚Üí main"
          body: "PR autom√°tico generado por auto-fill."
          labels: auto-pr, needs-review
          assignees: AngelGota
          author: AngelGota <gangelos630@gmail.com>
          committer: AngelGota <gangelos630@gmail.com>
