name: 4. Auto-merge si hay 1 comentario + 1 approve

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read
  issues: read

jobs:
  scan-and-merge:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
    steps:
      - name: Asegurar GH CLI y JQ
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh
          gh --version

      - name: Verificar PRs abiertos y mergear si cumplen
        shell: bash
        run: |
          set -euo pipefail

          OWNER_REPO="${REPO}"
          echo "üîç Buscando PRs abiertos en $OWNER_REPO..."

          # Lista PRs abiertos (no draft)
          mapfile -t PRS < <(gh api "repos/${OWNER_REPO}/pulls?state=open" --jq '.[] | select(.draft==false) | .number')

          [[ ${#PRS[@]} -eq 0 ]] && { echo "No hay PRs abiertos (no draft)."; exit 0; }

          for PR in "${PRS[@]}"; do
            echo "---- Evaluando PR #$PR ----"

            # Comentarios
            COMMENTS=$(gh api "repos/${OWNER_REPO}/issues/${PR}/comments" --jq 'length')

            # Aprobaciones
            APPROVALS=$(gh api "repos/${OWNER_REPO}/pulls/${PR}/reviews" \
              --jq '[ group_by(.user.login) | map(.[-1].state) | map(select(.=="APPROVED")) | length ] | add')

            # SHA del head
            SHA=$(gh api "repos/${OWNER_REPO}/pulls/${PR}" --jq .head.sha)

            # Checks combinados
            CHECKS_STATE=$(gh api "repos/${OWNER_REPO}/commits/${SHA}/status" --jq .state)

            # Estado mergeable
            MERGEABLE_STATE=$(gh api "repos/${OWNER_REPO}/pulls/${PR}" --jq .mergeable_state)

            echo "üìä Comentarios: $COMMENTS | Approvals: $APPROVALS | Checks: $CHECKS_STATE | Mergeable: $MERGEABLE_STATE"

            if [[ "$COMMENTS" -ge 1 && "$APPROVALS" -ge 1 && "$CHECKS_STATE" == "success" ]]; then
              case "$MERGEABLE_STATE" in
                clean|unstable|has_hooks)
                  echo "‚úÖ Cumple criterios. Mergeando (squash + delete branch)..."
                  if [[ -z "${GH_PAT:-}" ]]; then
                    echo "‚ùå GH_PAT no configurado. Crea el secret GH_PAT para mergear como tu usuario."
                    exit 1
                  fi

                  GH_TOKEN="$GH_PAT" gh pr merge "$PR" --repo "$OWNER_REPO" --squash --delete-branch \
                    --subject "$(gh api "repos/${OWNER_REPO}/pulls/${PR}" --jq .title)"

                  gh pr comment "$PR" --repo "$OWNER_REPO" --body \
                    "‚úÖ **GotaBot:** PR mergeado autom√°ticamente por @AngelGota (comentarios y approvals m√≠nimos cumplidos)."
                  ;;
                *)
                  echo "‚õî No mergeable todav√≠a (estado: $MERGEABLE_STATE). Se omite."
                  ;;
              esac
            else
              echo "‚è≠ No cumple m√≠nimos (comentarios>=1, approvals>=1, checks=success)."
            fi
          done
