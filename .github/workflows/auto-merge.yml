name: 4. Auto-merge si hay 1 comentario + 1 approve

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read
  issues: read

jobs:
  scan-and-merge:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
    steps:
      - name: Actualizar GitHub CLI (gh)
        run: |
          echo "‚¨ÜÔ∏è Instalando la √∫ltima versi√≥n de gh CLI..."
          sudo apt-get update -y
          sudo apt-get install -y jq
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          gh --version

      - name: Verificar PRs abiertos y mergear si cumplen
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Buscando PRs abiertos en $REPO..."

          # Lista PRs abiertos (no draft)
          mapfile -t PRS < <(gh pr list --repo "$REPO" --state open --json number,isDraft \
                              --jq '.[] | select(.isDraft==false) | .number')

          [[ ${#PRS[@]} -eq 0 ]] && { echo "No hay PRs abiertos (no draft)."; exit 0; }

          for PR in "${PRS[@]}"; do
            echo "---- Evaluando PR #$PR ----"

            # Comentarios (fix)
            COMMENTS=$(gh pr view "$PR" --repo "$REPO" --json comments --jq '.comments | length')

            # Aprobaciones (fix)
            APPROVALS=$(gh pr reviews "$PR" --repo "$REPO" --json author,state \
              --jq 'group_by(.author.login) | map(.[-1].state) | map(select(.=="APPROVED")) | length')

            # SHA + checks
            SHA=$(gh pr view "$PR" --repo "$REPO" --json headRefOid --jq .headRefOid)
            CHECKS_STATE=$(gh api "repos/${REPO}/commits/${SHA}/status" --jq .state)

            # Mergeable
            MERGEABLE_STATE=$(gh api "repos/${REPO}/pulls/${PR}" --jq .mergeable_state)

            echo "üìä Comentarios: $COMMENTS | Approvals: $APPROVALS | Checks: $CHECKS_STATE | Mergeable: $MERGEABLE_STATE"

            if [[ "$COMMENTS" -ge 1 && "$APPROVALS" -ge 1 && "$CHECKS_STATE" == "success" ]]; then
              case "$MERGEABLE_STATE" in
                clean|unstable|has_hooks)
                  echo "‚úÖ Cumple criterios. Haciendo merge (squash) y borrando rama‚Ä¶"
                  if [[ -z "${GH_PAT:-}" ]]; then
                    echo "‚ùå GH_PAT no configurado. Crea el secret GH_PAT para mergear como tu usuario."
                    exit 1
                  fi
                  GH_TOKEN="$GH_PAT" gh pr merge "$PR" --repo "$REPO" --squash --delete-branch \
                    --subject "$(gh pr view "$PR" --repo "$REPO" --json title --jq .title)" || \
                    echo "‚ö†Ô∏è No se pudo mergear PR #$PR (posible condici√≥n de protecci√≥n de rama)."
                  ;;
                *)
                  echo "‚õî No mergeable todav√≠a (estado: $MERGEABLE_STATE). Se omite."
                  ;;
              esac
            else
              echo "‚è≠ No cumple m√≠nimos (comentarios>=1, approvals>=1, checks=success)."
            fi
          done
