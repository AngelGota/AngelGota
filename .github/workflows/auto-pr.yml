name: Auto PR para todas las feature/*

on:
  schedule:
    - cron: "*/10 * * * *"  # cada 10 min (UTC)
  workflow_dispatch:
  push:
    branches:
      - 'feature/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  open-prs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Crear PRs faltantes (feature/* → main)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          # Listar ramas remotas feature/*
          mapfile -t BRANCHES < <(git ls-remote --heads "https://github.com/${REPO}.git" 'refs/heads/feature/*' | awk '{print $2}' | sed 's@refs/heads/@@')

          for HEAD in "${BRANCHES[@]}"; do
            # ¿PR abierto ya?
            if gh pr list --repo "${REPO}" --head "${HEAD}" --base "main" --state open --json number --jq '.[0].number' >/dev/null 2>&1; then
              echo "✔ PR ya existe para ${HEAD}"
              continue
            fi

            # ¿Hay diff real contra main?
            git fetch origin "${HEAD}" main
            if git rev-list --left-right --count "origin/main...origin/${HEAD}" | awk '{exit !($2>0)}'; then
              echo "↗ Crear PR para ${HEAD}"
              gh pr create \
                --repo "${REPO}" \
                --base main \
                --head "${HEAD}" \
                --title "feat: ${HEAD} → main" \
                --body "PR automático generado por auto-pr." \
                --label "needs-review" \
                --label "auto-pr" || true
            else
              echo "⏭ Sin cambios vs main en ${HEAD}"
            fi
          done
