name: Auto Create Pull Request
on:
  push:
    branches:
      - 'feature/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (no hace falta histórico)
        uses: actions/checkout@v4

      - name: Asegurar GH CLI logueado
        run: echo "ok"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear PR si no existe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.ref_name }}
        run: |
          # ¿Ya existe PR abierto desde HEAD_BRANCH hacia main?
          if gh pr list --head "$HEAD_BRANCH" --base "main" --state open --json number --jq '.[0].number' >/dev/null 2>&1; then
            echo "PR ya existe, no se crea otro."
            exit 0
          fi

          # Crear PR
          gh pr create \
            --base main \
            --head "$HEAD_BRANCH" \
            --title "feat: merge $HEAD_BRANCH → main" \
            --body "PR automático generado por workflow." \
            --label "auto-pr" --label "needs-review" \
            --reviewer "AngelGota" || true
