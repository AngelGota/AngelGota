name: 3. Auto review + AutoCommentGotaBot + AutoApprove

on:
  schedule:
    - cron: "*/5 * * * *"   # cada 5 minutos
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write
  issues: read
  checks: read
  statuses: read

jobs:
  # === Solo cuando el evento es pull_request ===
  on-pr-event:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      PR: ${{ github.event.pull_request.number }}
    steps:
      - name: Esperar checks OK
        uses: lewagon/wwait-on-check-action@v1.3.3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          wait-interval: 10
          allowed-conclusions: success,neutral,skipped
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Descubrir si ya existe comentario GotaBot, si hay APPROVED y/o CHANGES_REQUESTED
      - name: Hechos del PR
        id: facts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # ¬øYa existe el comentario GotaBot?
          COMMENT_EXISTS=$(gh api repos/${REPO}/issues/${PR}/comments --jq \
            '[ .[].body | tostring | contains("GotaBot ‚Äì Generic Review") ] | any')
          # ¬øHay APPROVED?
          APPROVED=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq \
            '[.[].state] | any(.=="APPROVED")')
          # ¬øHay CHANGES_REQUESTED?
          CHANGES=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq \
            '[.[].state] | any(.=="CHANGES_REQUESTED")')

          echo "comment_exists=$COMMENT_EXISTS" >> "$GITHUB_OUTPUT"
          echo "approved=$APPROVED"            >> "$GITHUB_OUTPUT"
          echo "changes=$CHANGES"              >> "$GITHUB_OUTPUT"

          echo "COMMENT_EXISTS=$COMMENT_EXISTS | APPROVED=$APPROVED | CHANGES=$CHANGES"

      - name: Comentario GotaBot (solo si falta)
        if: steps.facts.outputs.comment_exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "$PR" --repo "$REPO" --body $'ü§ñ **GotaBot ‚Äì Generic Review**\n‚Ä¢ CI ‚úì\n‚Ä¢ Base: `main`\n‚Ä¢ Autor: @${{ github.actor }}\n\n> Revisi√≥n autom√°tica completada.'

      - name: Aprobar como AngelGota (si no hay APPROVED y sin CHANGES_REQUESTED)
        if: steps.facts.outputs.approved == 'false' && steps.facts.outputs.changes == 'false' && env.GH_PAT != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}   # PAT de tu usuario
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          gh pr review "$PR" --repo "$REPO" --approve --body "Auto-approval by AngelGota (CI OK)."

  # === Corre con ejecuci√≥n manual y con el cron ===
  backfill-open-prs:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      REPO: ${{ github.repository }}
    steps:
      - name: Listar PRs abiertos
        id: list
        run: |
          gh pr list --repo "$REPO" --state open --json number --jq '.[].number' > prs.txt || true
          echo "prs<<EOF" >> $GITHUB_OUTPUT; cat prs.txt >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT
          echo "Open PRs:"; cat prs.txt || true

      - name: Procesar PRs abiertos
        if: steps.list.outputs.prs != ''
        run: |
          set -euo pipefail

          wait_checks () {
            local sha="$1" tries=0 max=120
            while :; do
              state=$(gh api repos/${REPO}/commits/${sha}/status --jq .state)
              echo "Checks state: $state"
              [[ "$state" == "success" ]] && return 0
              [[ "$state" == "failure" ]] && { echo "Checks failed"; return 1; }
              ((tries++)); [[ $tries -ge $max ]] && { echo "Timeout"; return 1; }
              sleep 5
            done
          }

          while read -r PR; do
            [[ -z "$PR" ]] && continue
            echo "== PR #$PR =="

            SHA=$(gh pr view "$PR" --repo "$REPO" --json headRefOid --jq .headRefOid)
            wait_checks "$SHA"

            # Hechos del PR
            COMMENT_EXISTS=$(gh api repos/${REPO}/issues/${PR}/comments --jq \
              '[ .[].body | tostring | contains("GotaBot ‚Äì Generic Review") ] | any')
            APPROVED=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq \
              '[.[].state] | any(.=="APPROVED")')
            CHANGES=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq \
              '[.[].state] | any(.=="CHANGES_REQUESTED")')

            # Comentar si hace falta
            if [[ "$COMMENT_EXISTS" != "true" ]]; then
              gh pr comment "$PR" --repo "$REPO" --body $'ü§ñ **GotaBot ‚Äì Generic Review**\n‚Ä¢ Backfill\n\n> Checks OK.'
            fi

            # Saltar si hay CHANGES_REQUESTED
            if [[ "$CHANGES" == "true" ]]; then
              gh pr comment "$PR" --repo "$REPO" --body "üîé GotaBot: *changes requested* detectado. No se aprueba."
              continue
            fi

            # Aprobar si falta APPROVED y tenemos PAT
            if [[ "$APPROVED" != "true" && -n "${GH_PAT:-}" ]]; then
              GH_TOKEN="$GH_PAT" gh pr review "$PR" --repo "$REPO" --approve --body "Auto-approval by AngelGota (backfill)."
              gh pr comment "$PR" --repo "$REPO" --body "‚úÖ GotaBot: Checks OK y aprobado por AngelGota."
            elif [[ "$APPROVED" == "true" ]]; then
              echo "Ya existe un APPROVED, no se aprueba de nuevo."
            else
              gh pr comment "$PR" --repo "$REPO" --body "‚ÑπÔ∏è GotaBot: Checks OK. No se aprob√≥ por falta de GH_PAT."
            fi
          done < prs.txt
