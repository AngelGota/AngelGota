name: ValidaciÃ³n de review + Comentario GotaBot + Auto-approve + Merge

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  workflow_dispatch: {}

permissions:
  contents: write        # para poder mergear
  pull-requests: write
  checks: read
  statuses: read

jobs:
  on-pr-event:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      # (Opcional) espera a que los checks terminen ok
      - name: Esperar checks OK
        uses: lewagon/wait-on-check-action@v1.3.3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          wait-interval: 10
          allowed-conclusions: success,neutral,skipped
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comentario GotaBot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR" --repo "$REPO" --body $'ðŸ¤– **GotaBot â€“ Generic Review**\nâ€¢ CI âœ“\nâ€¢ Base: `main`\nâ€¢ Autor: @${{ github.actor }}\n\n> RevisiÃ³n automÃ¡tica completada.'

      - name: Bloquear si hay CHANGES_REQUESTED
        id: revs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          CR=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq '[.[].state] | any(.=="CHANGES_REQUESTED")')
          echo "changes=$CR" >> $GITHUB_OUTPUT
          [[ "$CR" == "true" ]] && echo "Hay CHANGES_REQUESTED; no se aprobarÃ¡/mergearÃ¡."

      - name: Aprobar como AngelGota
        if: steps.revs.outputs.changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}   # tu PAT
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          gh pr review "$PR" --repo "$REPO" --approve --body "Auto-approval by AngelGota (CI OK)."

      - name: Merge (squash) y borrar rama
        if: steps.revs.outputs.changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}   # tu PAT (merge como tu usuario)
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
        run: |
          gh pr merge "$PR" --repo "$REPO" --squash --delete-branch --subject "$(gh pr view "$PR" --repo "$REPO" --json title --jq .title)"

  backfill-open-prs:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
      GH_PAT: ${{ secrets.GH_PAT }}
    steps:
      - name: Listar PRs abiertos
        id: list
        run: |
          gh pr list --repo "$REPO" --state open --json number --jq '.[].number' > prs.txt || true
          echo "prs<<EOF" >> $GITHUB_OUTPUT; cat prs.txt >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT
          echo "Open PRs:"; cat prs.txt || true

      - name: Procesar PRs
        if: steps.list.outputs.prs != ''
        run: |
          set -euo pipefail
          wait_checks () {
            local sha="$1" tries=0 max=120
            while :; do
              state=$(gh api repos/${REPO}/commits/${sha}/status --jq .state)
              echo "Checks state: $state"
              [[ "$state" == "success" ]] && return 0
              [[ "$state" == "failure" ]] && { echo "Checks failed"; return 1; }
              ((tries++)); [[ $tries -ge $max ]] && { echo "Timeout"; return 1; }
              sleep 5
            done
          }
          while read -r PR; do
            [[ -z "$PR" ]] && continue
            echo "== PR #$PR =="

            gh pr comment "$PR" --repo "$REPO" --body $'ðŸ¤– **GotaBot â€“ Generic Review**\nâ€¢ Backfill\n\n> Esperando checks...'
            SHA=$(gh pr view "$PR" --repo "$REPO" --json headRefOid --jq .headRefOid)
            wait_checks "$SHA"

            CR=$(gh pr reviews --repo "$REPO" "$PR" --json state --jq '[.[].state] | any(.=="CHANGES_REQUESTED")')
            if [[ "$CR" == "true" ]]; then
              gh pr comment "$PR" --repo "$REPO" --body "ðŸ”Ž GotaBot: *changes requested* detectado. No se aprueba."
              continue
            fi

            GH_TOKEN="$GH_PAT" gh pr review "$PR" --repo "$REPO" --approve --body "Auto-approval by AngelGota (backfill)."
            GH_TOKEN="$GH_PAT" gh pr merge  "$PR" --repo "$REPO" --squash --delete-branch --subject "$(gh pr view "$PR" --repo "$REPO" --json title --jq .title)"
            gh pr comment "$PR" --repo "$REPO" --body "âœ… GotaBot: Aprobado y mergeado por AngelGota."
          done < prs.txt
